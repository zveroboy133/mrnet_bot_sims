#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∫–∞–∫ –¥–µ–º–æ–Ω–∞

BOT_PID_FILE="bot.pid"
BOT_LOG_FILE="bot.log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ Pachka –∫–∞–∫ –¥–µ–º–æ–Ω–∞..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
cd "$SCRIPT_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç
if [ -f "$BOT_PID_FILE" ]; then
    PID=$(cat "$BOT_PID_FILE")
    if ps -p $PID > /dev/null 2>&1; then
        echo "‚ö†Ô∏è –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Å PID: $PID"
        echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: kill $PID"
        exit 1
    else
        echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π PID —Ñ–∞–π–ª"
        rm -f "$BOT_PID_FILE"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f ".env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üìù –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:"
    echo "   PACHKA_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–∑–¥–µ—Å—å"
    exit 1
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d "find_sims_env" ]; then
    echo "üîß –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    source find_sims_env/bin/activate
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º waitress –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install waitress

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å –ø–æ–ª–Ω—ã–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
nohup python3 start_bot.py > "$BOT_LOG_FILE" 2>&1 &
BOT_PID=$!

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID
echo $BOT_PID > "$BOT_PID_FILE"

echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å PID: $BOT_PID"
echo "üìä –õ–æ–≥–∏: tail -f $BOT_LOG_FILE"
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: kill $BOT_PID"
echo "üîç –°—Ç–∞—Ç—É—Å: ps aux | grep $BOT_PID"

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 5
if ps -p $BOT_PID > /dev/null 2>&1; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    SERVER_HOST=${SERVER_HOST:-localhost}
    SERVER_PORT=${SERVER_PORT:-5000}
    echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: curl http://${SERVER_HOST}:${SERVER_PORT}/health"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: cat $BOT_LOG_FILE"
    rm -f "$BOT_PID_FILE"
    exit 1
fi 