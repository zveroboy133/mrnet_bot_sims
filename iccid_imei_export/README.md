# Скрипт выгрузки ICCID:IMEI из Google Sheets

## Описание

Этот скрипт предназначен для автоматической выгрузки данных ICCID и IMEI из Google Sheets и создания CSV файлов для различных операторов связи (МТС, Теле2, Билайн) в требуемых форматах.

## Функционал

### Основные возможности:

1. **Чтение данных из Google Sheets**
   - Подключается к таблице Google Sheets (лист "SIMS")
   - Читает данные из столбцов ICCID (столбец E) и IMEI
   - Обрабатывает все строки таблицы

2. **Определение оператора по ICCID**
   - МТС: префикс `8970101`
   - Мегафон: префикс `8970102`
   - Теле2: префикс `8970120`
   - Билайн: префикс `8970199`

3. **Создание CSV файлов для операторов**

   **МТС:**
   - Формат: `MTS_ICCID_IMEI_YYYYMMDD_HHMMSS.csv`
   - Структура: `ICCID;IMEI` (с заголовком)
   - Пример:
     ```
     ICCID;IMEI
     8970101829127954974;352240890697274
     ```

   **Теле2:**
   - Формат: `Теле2_YYYYMMDD_HHMMSS.csv`
   - Структура: `ICCID;IMEI` (с заголовком)
   - Пример:
     ```
     ICCID;IMEI
     8970120629565009518;352240890697275
     ```

   **Билайн:**
   - Создает два файла:
     1. `Билайн_ICCID_YYYYMMDD_HHMMSS.csv` - список ICCID (по одному на строку, без заголовка)
     2. `Билайн_IMEI_YYYYMMDD_HHMMSS.csv` - список IMEI в формате `type;value` (без заголовка)
   - Примеры:
     ```
     Билайн_ICCID_*.csv:
     897019924090956894
     
     Билайн_IMEI_*.csv:
     IMEI;352240890697276
     ```

4. **Статистика и отчеты**
   - Показывает количество обработанных строк
   - Выводит статистику по операторам
   - Предупреждает о записях с неизвестными операторами
   - Показывает примеры первых записей

## Требования

### Зависимости Python:
- `gspread` - для работы с Google Sheets API
- `google-auth` - для аутентификации
- `google-auth-oauthlib` - для OAuth 2.0 потока
- `google-api-python-client` - для работы с Google API

### Установка зависимостей:
```bash
pip install gspread google-auth google-auth-oauthlib google-api-python-client
```

### Файлы конфигурации:

1. **Файл учетных данных Google API** (`client_secret.json` или `credentials.json`)
   - Должен быть размещен в одной из следующих директорий:
     - Текущая директория скрипта
     - Родительская директория
     - `../mrnet_ssh/`
   - Получается из Google Cloud Console при создании OAuth 2.0 credentials

2. **Токен доступа** (`token.json`)
   - Создается автоматически при первом запуске
   - Сохраняется в той же директории, что и файл учетных данных
   - Обновляется автоматически при истечении срока действия

## Использование

### Запуск скрипта:

```bash
python main.py
```

### Процесс работы:

1. Скрипт ищет файл с учетными данными Google API
2. При первом запуске может потребоваться авторизация через браузер
3. Подключается к Google Sheets (ID таблицы: `1nx2QSynzcvt_gOb8gsC0l6Zs7nb7V_x-19kOLx93-WI`)
4. Читает данные из листа "SIMS"
5. Обрабатывает данные и группирует по операторам
6. Создает CSV файлы в директории `exports/`
7. Выводит статистику и примеры

### Структура выходных файлов:

```
iccid_imei_export/
├── main.py
├── README.md
└── exports/
    ├── MTS_ICCID_IMEI_20251216_232836.csv
    ├── Теле2_20251216_232836.csv
    ├── Билайн_ICCID_20251216_232836.csv
    └── Билайн_IMEI_20251216_232836.csv
```

## Особенности реализации

### Обработка данных:

- **Нормализация ICCID и IMEI**: извлекаются только цифры из значений
- **Определение оператора**: по первым цифрам ICCID
- **Валидация**: проверка наличия цифр в IMEI и ICCID
- **Обработка ошибок**: запись с неизвестным оператором сохраняется для анализа

### Производительность:

- Загружает все данные из таблицы за один запрос
- Обрабатывает данные в памяти
- Создает файлы последовательно

## Интеграция в другие проекты

Для использования в другом проекте:

1. Скопируйте папку `iccid_imei_export` в ваш проект
2. Убедитесь, что `google_sheets_processor.py` доступен для импорта:
   - Либо скопируйте его в родительскую директорию
   - Либо измените путь импорта в `main.py`
3. Разместите файл `client_secret.json` в одной из ожидаемых директорий
4. Установите зависимости Python
5. Запустите скрипт

### Для запуска на сервере:

1. Убедитесь, что на сервере установлен Python 3.6+
2. Установите зависимости: `pip install -r requirements.txt` (если создан)
3. Разместите файл `client_secret.json` с учетными данными
4. При первом запуске может потребоваться авторизация (если используется OAuth flow)
5. Для автоматического запуска можно использовать cron или systemd timer

## Обработка ошибок

Скрипт обрабатывает следующие ошибки:

- Отсутствие файла учетных данных
- Ошибки подключения к Google Sheets API
- Отсутствие требуемых столбцов в таблице
- Ошибки записи CSV файлов
- Записи с неизвестными операторами

Все ошибки выводятся в консоль с подробным описанием.

## Автор

Система автоматизации OTK Helper

## Версия

1.0
